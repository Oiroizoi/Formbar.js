<%- include('../partials/header_content') %>
<%- include('../partials/sockets') %>
<!-- ^^ This means add this file into the contents of the header page -->
<!-- This is where the title, top buttons, and stylesheet is located -->

<body id="colorContent">
    <%- include('../partials/formbar_header') %>
    <div id="content" class="contentBox">
        <button id="logInButton" class="pressed quickButton" onclick="changeloginType(this);">Log in</button>
        <button id="newAccountButton" class="quickButton" onclick="changeloginType(this);">New account</button>
        <button id="guestButton" class="quickButton" onclick="changeloginType(this);">Use as guest</button>
        <br><br>
        <form id="login" action="login" method="post" style="margin-bottom: 16px;">
            <!-- Carries over and submits the redirectURL specified by the user. -->
            <input type="hidden" id="redirect" name="redirectURL" value="<%-redirectURL%>">
            <input type="text" id="usernameBox" name="username" class="loginBox" placeholder="Name" value=""
                autocomplete="off" pattern="[a-zA-Z0-9_]+" required>
            <p style="font-size: small; font-weight: bold; color: black;" id="passwordInfo">
                *Username may only contain: a-z, A-Z, 0-9, and _.
            </p>
            <input type="email" id="emailBox" name="email" class="loginBox" placeholder="Email" value="">
            <input type="password" id="passwordBox" name="password" class="loginBox" placeholder="Password" value=""
                pattern="[a-z0-9A-Z!@#$%^&*_?]+" minlength="8" maxlength="32" required>
            <input type="text" id="displayNameBox" name="displayName" class="loginBox" placeholder="Display Name"
                value="" pattern="[a-zA-Z0-9]+" required>
            <p style="font-size: small; font-weight: bold; color: black;" id="passwordInfo">
                *Passwords may only contain: a-z, A-Z, 0-9, !, @, #, $, ^, %, &, *, _, and ?.
            </p>
            <a href="/changepassword" id="forgotPassword" class="quickButton loginBox">Forgot password</a>
            <input type="hidden" id="loginTypeBox" name="loginType" value="login">
            <input type="hidden" id="userTypeBox" name="userType" value="user">
            <br><br>
            <input type="submit" id="submitButton" class="button unselectable quickButton" value="Log in"
                onsubmit="return false;">
        </form>
    </div>
</body>

<%- include('../partials/footer_content') %>
<script type="text/javascript">
    // Prevent submission if a field is blank
    const form = document.getElementById('login');
    const redirect = document.getElementById('redirect');
    let loginButton = document.getElementById('logInButton');
    let newAccountButton = document.getElementById('newAccountButton');
    let guestButton = document.getElementById('guestButton');
    let usernameBox = document.getElementById('usernameBox');
    let emailBox = document.getElementById('emailBox');
    let passwordBox = document.getElementById('passwordBox');
    let displayNameBox = document.getElementById('displayNameBox');
    let loginTypeBox = document.getElementById('loginTypeBox');
    let passwordInfo = document.getElementById('passwordInfo');
    let forgotPassword = document.getElementById('forgotPassword');
    let submitButton = document.getElementById('submitButton');

    // If a redirect value is given...
    if (redirect.value) {
        // Change the form action to 'oauth' and hide the buttons to change the login type
        form.action = 'oauth';
        loginButton.style.display = 'none';
        newAccountButton.style.display = 'none';
        guestButton.style.display = 'none';
    }

    function changeloginType(el) {
        [loginButton, newAccountButton, guestButton].forEach(button => 
            (button === el) ? button.classList.add('pressed') : button.classList.remove('pressed')
        );

        // Hide or show inputs based on the selected login type
        switch (el) {
            case loginButton:
                passwordBox.classList.remove('hidden');
                passwordBox.required = true;
                passwordInfo.classList.remove('hidden');
                forgotPassword.classList.remove('hidden');
                displayNameBox.classList.add('hidden');
                usernameBox.classList.remove('hidden');
                emailBox.classList.add('hidden');
                emailBox.required = false;
                displayNameBox.required = false;
                submitButton.value = 'Log in';
                loginTypeBox.value = 'login';
                break;
            case newAccountButton:
                passwordBox.classList.remove('hidden');
                passwordBox.required = true;
                passwordInfo.classList.remove('hidden');
                forgotPassword.classList.add('hidden');
                displayNameBox.classList.remove('hidden');
                usernameBox.classList.remove('hidden');
                emailBox.classList.remove('hidden');
                emailBox.required = true;
                displayNameBox.required = true;
                submitButton.value = 'Create account';
                loginTypeBox.value = 'new';
                break;
            case guestButton:
                usernameBox.value = null;
                usernameBox.classList.add('hidden');
                passwordBox.value = null;
                passwordBox.classList.add('hidden');
                passwordBox.required = false;
                passwordInfo.classList.add('hidden');
                forgotPassword.classList.add('hidden');
                displayNameBox.classList.remove('hidden');
                emailBox.classList.add('hidden');
                emailBox.required = false;
                displayNameBox.required = true;
                submitButton.value = 'Go';
                loginTypeBox.value = 'guest';
                break;
        }

        // Set if the inputs are required based on if they are visible
        usernameBox.required = !usernameBox.classList.contains('hidden');
        emailBox.required = !emailBox.classList.contains('hidden');
        displayNameBox.required = !displayNameBox.classList.contains('hidden');
        passwordBox.required = !passwordBox.classList.contains('hidden');

        // Focus on the first visible input
        if (!usernameBox.classList.contains('hidden')) {
            usernameBox.focus();
        } else if (!displayNameBox.classList.contains('hidden')) {
            displayNameBox.focus();
        }

        checkIfBlank();
    }

    function checkIfBlank() {
        if ((usernameBox.value || loginTypeBox.value === 'guest') && (passwordBox.value || loginTypeBox.value === 'guest') && (displayNameBox.value || loginTypeBox.value === 'login')) {
            submitButton.classList.remove('unselectable');
            submitButton.onsubmit = () => true;
        } else {
            submitButton.classList.add('unselectable');
            submitButton.onsubmit = () => false;
        }
    }

    usernameBox.oninput = checkIfBlank;
    passwordBox.oninput = checkIfBlank;
    displayNameBox.oninput = checkIfBlank;

    changeloginType(loginButton);
</script>
